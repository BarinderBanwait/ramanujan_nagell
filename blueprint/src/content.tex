% In this file you should put the actual content of the blueprint.
% It will be used both by the web and the print version.
% It should *not* include the \begin{document}
%
% If you want to split the blueprint content into several files then
% the current file can be a simple sequence of \input. Otherwise It
% can start with a \section or \chapter for instance.

\chapter{The Ramanujan--Nagell Theorem}

The Ramanujan--Nagell equation is the Diophantine equation
\[
  x^2 + 7 = 2^n
\]
where $x$ is an integer and $n$ is a natural number. The theorem, conjectured by
Ramanujan and proved by Nagell, states that the only solutions are
$(x, n) \in \{(\pm 1, 3),\; (\pm 3, 4),\; (\pm 5, 5),\; (\pm 11, 7),\; (\pm 181, 15)\}$.

The proof splits into two cases depending on the parity of $n$: the even case uses a
factorization argument over $\mathbb{Z}$, while the odd case requires algebraic number
theory in the ring of integers of $\mathbb{Q}(\sqrt{-7})$.

\section{Setup: the ring of integers of $\mathbb{Q}(\sqrt{-7})$}

We model $\mathbb{Q}(\sqrt{-7})$ as the quadratic algebra $K = \texttt{QuadraticAlgebra}\;\mathbb{Q}\;(-2)\;1$,
where the generator $\omega$ satisfies $\omega^2 = -2 + \omega$, i.e.\
$\omega = (1 + \sqrt{-7})/2$. We write $R = \mathcal{O}_K$ for the ring of integers,
$\theta = \omega \in R$, and $\theta' = 1 - \omega = (1 - \sqrt{-7})/2 \in R$.

\begin{lemma}[Integrality of $\omega$]
  \label{lem:is_integral_omega}
  \lean{is_integral_ω}
  \leanok
  The element $\omega \in K$ is integral over $\mathbb{Z}$: it satisfies $X^2 - X + 2 = 0$.
\end{lemma}
\begin{proof}\leanok
  Exhibit the monic polynomial $X^2 - X + 2$ and verify $\omega^2 - \omega + 2 = 0$.
\end{proof}

\begin{lemma}[Integrality of $1 - \omega$]
  \label{lem:is_integral_one_sub_omega}
  \lean{is_integral_one_sub_ω}
  \uses{lem:is_integral_omega}
  \leanok
  The element $1 - \omega \in K$ is integral over $\mathbb{Z}$.
\end{lemma}
\begin{proof}\leanok
  Exhibit the same monic polynomial $X^2 - X + 2$ and verify $(1-\omega)^2 - (1-\omega) + 2 = 0$.
\end{proof}

\begin{lemma}[Minimal polynomial]
  \label{lem:my_minpoly}
  \lean{my_minpoly}
  \uses{lem:is_integral_omega}
  The minimal polynomial of $\theta$ over $\mathbb{Z}$ is $X^2 - X + 2$.
\end{lemma}

\begin{lemma}[Monogenicity]
  \label{lem:span_eq_top}
  \lean{span_eq_top}
  \uses{lem:is_integral_omega}
  The ring of integers $R$ is generated by $\theta$ over $\mathbb{Z}$: $\mathbb{Z}[\theta] = R$.
\end{lemma}

\begin{lemma}[Class number one]
  \label{lem:class_number_one}
  \lean{class_number_one}
  The ring of integers $R$ is a unique factorization domain
  (equivalently, the class number of $\mathbb{Q}(\sqrt{-7})$ is $1$).
\end{lemma}

\begin{lemma}[Class number one implies PID]
  \label{lem:class_number_one_PID}
  \lean{class_number_one_PID}
  \uses{lem:class_number_one}
  The ring of integers $R$ is a principal ideal ring.
\end{lemma}

\begin{lemma}[Algebra norm equals quadratic norm]
  \label{lem:algebra_norm_eq_quadratic_norm}
  \lean{algebra_norm_eq_quadratic_norm}
  For any $z \in K$, the Mathlib algebra norm $\mathrm{Norm}_{\mathbb{Q}}(z)$
  coincides with the quadratic algebra norm $z \cdot \bar{z}$.
\end{lemma}

\begin{lemma}[Units are $\pm 1$]
  \label{lem:units_pm_one}
  \lean{units_pm_one}
  The only units in $R$ are $\pm 1$.
\end{lemma}

\begin{lemma}[Factorization of $2$]
  \label{lem:two_factorisation_R}
  \lean{two_factorisation_R}
  \uses{lem:is_integral_omega}
  In $R$, we have $\theta \cdot (1 - \theta) = 2$, i.e.\
  $\frac{1+\sqrt{-7}}{2} \cdot \frac{1-\sqrt{-7}}{2} = 2$.
\end{lemma}

\begin{lemma}[Exponent of $\theta$]
  \label{lem:exponent}
  \lean{exponent}
  \uses{lem:span_eq_top}
  \leanok
  The exponent of $\theta$ (in the sense of Kummer--Dedekind) is $1$.
  This follows immediately from the fact that $\mathbb{Z}[\theta] = R$
  (Lemma~\ref{lem:span_eq_top}).
\end{lemma}
\begin{proof}\leanok
  Rewrite using the characterization of exponent $1$ and apply monogenicity.
\end{proof}

\begin{lemma}[No prime divides the exponent]
  \label{lem:ne_dvd_exponent}
  \lean{ne_dvd_exponent}
  \uses{lem:exponent}
  \leanok
  For any prime $p$, $p$ does not divide the exponent of $\theta$.
  This is immediate since the exponent equals $1$ (Lemma~\ref{lem:exponent}).
\end{lemma}
\begin{proof}\leanok
  The exponent is $1$, so $p \mid 1$ implies $p = 1$, contradicting primality.
\end{proof}

\section{Parity lemmas}

\begin{lemma}[Odd square implies odd root]
  \label{lem:sq_odd_then_odd}
  \lean{sq_odd_then_odd}
  \leanok
  If $x^2$ is odd, then $x$ is odd.
\end{lemma}
\begin{proof}\leanok
  Contrapositive: if $x$ is even then $x^2$ is even.
\end{proof}

\begin{lemma}[Powers of two are not odd]
  \label{lem:not_odd_two_pow}
  \lean{not_odd_two_pow}
  \leanok
  For $n \geq 1$, the number $2^n$ is not odd.
\end{lemma}
\begin{proof}\leanok
  $2^n$ is even for $n \geq 1$.
\end{proof}

\begin{lemma}[$2^n - 7$ is odd]
  \label{lem:two_pow_min_seven_odd}
  \lean{two_pow_min_seven_odd}
  \leanok
  For all $n \neq 0$, the integer $2^n - 7$ is odd.
\end{lemma}
\begin{proof}\leanok
  $2^n$ is even and $7$ is odd, so their difference is odd.
\end{proof}

\begin{lemma}[$x$ is odd]
  \label{lem:x_is_odd}
  \lean{x_is_odd}
  \uses{lem:sq_odd_then_odd, lem:two_pow_min_seven_odd}
  \leanok
  If $x^2 + 7 = 2^n$ with $n \neq 0$, then $x$ is odd.
\end{lemma}
\begin{proof}\leanok
  $x^2 = 2^n - 7$ is odd, so $x$ is odd.
\end{proof}

\section{The even case}

When $n$ is even, say $n = 2k$, the equation becomes $x^2 + 7 = 2^{2k}$, which factors
over $\mathbb{Z}$ as $(2^k + x)(2^k - x) = 7$. Since $7$ is prime, this forces
$n = 4$ and $x = \pm 3$.

\begin{lemma}[Factorization over $\mathbb{Z}$]
  \label{lem:ramanujan_nagell_even_pow_factors}
  \lean{ramanujan_nagell_even_pow_factors}
  \leanok
  If $(2^k + x)(2^k - x) = 7$, then either $2^k - x = 1$ and $2^k + x = 7$,
  or $2^k - x = 7$ and $2^k + x = 1$.
\end{lemma}
\begin{proof}\leanok
  Both factors are positive integers whose product is the prime $7$,
  so one factor is $1$ and the other is $7$.
\end{proof}

\section{The odd case}

When $n$ is odd and $n \geq 5$, the proof works in the ring of integers of
$\mathbb{Q}(\sqrt{-7})$. Setting $m = n - 2$, we divide the equation by $4$
to obtain $(x^2 + 7)/4 = 2^m$, which factors in $R$ as
$\theta^m \cdot \theta'^{\,m}$.
The conjugate factors $(x \pm \sqrt{-7})/2$ lie in $R$ (since $x$ is odd) and
their product equals $\theta^m \cdot \theta'^{\,m}$. Using unique factorization
and coprimality, one deduces the key identity $-2\theta + 1 = \theta^m - \theta'^{\,m}$.

\subsection{Exercises: from factorization to sign condition}

The proof of the main $m$-condition is structured as a chain of four
lemmas (exercises), followed by a sign-determination step.

\begin{lemma}[Conjugate factors in $R$]
  \label{lem:factors_in_R}
  \lean{factors_in_R_with_product}
  \uses{lem:is_integral_omega, lem:is_integral_one_sub_omega, lem:two_factorisation_R}
  \leanok
  The conjugate factors $(x \pm \sqrt{-7})/2$ lie in $R$ (since $x$ is odd),
  and their product equals $\theta^m \cdot \theta'^{\,m}$.
  Their difference is $2\theta - 1 = \sqrt{-7}$.
\end{lemma}
\begin{proof}\leanok
  Express the factors using $\theta$ and $\theta'$, verify the product
  using $\theta \cdot \theta' = 2$, and compute the difference.
\end{proof}

\begin{lemma}[Coprimality]
  \label{lem:coprime}
  \lean{conjugate_factors_coprime}
  \uses{lem:factors_in_R, lem:two_factorisation_R}
  \leanok
  The conjugate factors are coprime in $R$.
  The only prime factors of $2$ in $R$ are $\theta$ and $\theta'$
  (since $2 = \theta \cdot \theta'$). If either divided both factors,
  it would divide their difference $\sqrt{-7}$, but $N(\sqrt{-7}) = 7$ is
  not divisible by $N(\theta) = N(\theta') = 2$.
\end{lemma}
\begin{proof}\leanok
  Norm argument: any common factor divides $\sqrt{-7}$, whose norm is $7$,
  incompatible with the norm $2$ of $\theta$ and $\theta'$.
\end{proof}

\begin{lemma}[UFD power association]
  \label{lem:ufd_association}
  \lean{ufd_power_association}
  \uses{lem:coprime, lem:class_number_one, lem:units_pm_one}
  If $\alpha \cdot \beta = \theta^m \cdot \theta'^{\,m}$ and $\gcd(\alpha, \beta) = 1$ in the
  UFD $R$, then $\alpha = \pm\theta^m$ or $\alpha = \pm\theta'^{\,m}$.
  This combines unique factorization (\texttt{class\_number\_one}) with the fact that the
  only units are $\pm 1$ (\texttt{units\_pm\_one}).
\end{lemma}

\begin{lemma}[Eliminate $x$]
  \label{lem:eliminate_x}
  \lean{eliminate_x_conclude}
  \uses{lem:ufd_association}
  \leanok
  From $\alpha = \pm\theta^m$ or $\alpha = \pm\theta'^{\,m}$, use the product relation to
  determine $\beta$, then take the difference $\alpha - \beta = 2\theta - 1$ to
  eliminate $x$ and obtain: either $2\theta - 1 = \theta^m - \theta'^{\,m}$ or
  $-2\theta + 1 = \theta^m - \theta'^{\,m}$.
\end{lemma}
\begin{proof}\leanok
  Case split on the four possibilities for $\alpha$, determine $\beta$ from
  the product, and compute $\alpha - \beta$.
\end{proof}

\begin{lemma}[Must have minus sign]
  \label{lem:must_have_minus_sign}
  \lean{must_have_minus_sign}
  \uses{lem:eliminate_x}
  \leanok
  If either $2\theta - 1 = \theta^m - \theta'^{\,m}$ or $-2\theta + 1 = \theta^m - \theta'^{\,m}$
  holds for odd $m \geq 3$, then in fact the minus sign must hold:
  $-2\theta + 1 = \theta^m - \theta'^{\,m}$.
  This is proved by reducing modulo $\theta'^2$ and checking which sign is consistent.
\end{lemma}
\begin{proof}\leanok
  Reduce modulo $\theta'^2$ and verify only the minus sign is consistent.
\end{proof}

\subsection{Key intermediate result}

\begin{lemma}[Main $m$-condition]
  \label{lem:main_m_condition}
  \lean{main_m_condition}
  \uses{lem:factors_in_R, lem:coprime, lem:ufd_association, lem:eliminate_x, lem:must_have_minus_sign}
  \leanok
  For all integers $x$ and odd $m \geq 3$, if $(x^2 + 7)/4 = 2^m$, then
  \[
    -2\theta + 1 = \theta^m - \theta'^{\,m}.
  \]
\end{lemma}
\begin{proof}\leanok
  Chain the exercises: construct the conjugate factors, prove coprimality,
  apply UFD association, eliminate $x$, then determine the sign.
\end{proof}

\subsection{From the $m$-condition to finitely many solutions}

\begin{lemma}[Reduction by dividing by $4$]
  \label{lem:reduction_divide_by_4}
  \lean{reduction_divide_by_4}
  \leanok
  If $n$ is odd with $n \geq 5$ and $x^2 + 7 = 2^n$, then $(x^2 + 7)/4 = 2^{n-2}$.
\end{lemma}
\begin{proof}\leanok
  Since $n \geq 5$, we have $4 \mid 2^n$, so divide both sides by $4$.
\end{proof}

\begin{lemma}[Binomial expansion mod $7$]
  \label{lem:expand_by_binomial}
  \lean{expand_by_binomial}
  \uses{lem:main_m_condition}
  \leanok
  From $-2\theta + 1 = \theta^m - \theta'^{\,m}$, expand via the binomial theorem
  and reduce modulo $7$ to obtain $-2^{m-1} \equiv m \pmod{7}$.

  The proof multiplies both sides by $2^m$, expands $(1 + \sqrt{-7})^m - (1 - \sqrt{-7})^m$
  via the binomial theorem, observes that even-index terms cancel and odd-index terms
  involve powers of $(\sqrt{-7})^2 = -7$, then reads the result modulo $7$.
\end{lemma}
\begin{proof}\leanok
  Binomial expansion and reduction modulo $7$.
\end{proof}

\begin{lemma}[Mod $7$ constraint]
  \label{lem:odd_case_mod_seven_constraint}
  \lean{odd_case_mod_seven_constraint}
  \uses{lem:main_m_condition, lem:reduction_divide_by_4, lem:expand_by_binomial}
  \leanok
  If $n$ is odd with $n \geq 5$ and $x^2 + 7 = 2^n$, then
  $(-2)^{n-3} \equiv n - 2 \pmod{7}$.

  This follows from the $m$-condition (Lemma~\ref{lem:main_m_condition}) by expanding
  $\theta^m - \theta'^{\,m}$ via the binomial theorem and reducing modulo $7$.
\end{lemma}
\begin{proof}\leanok
  Combine the reduction and binomial expansion lemmas.
\end{proof}

\begin{theorem}[Mod $42$ constraint]
  \label{thm:odd_case_mod_42}
  \lean{odd_case_only_three_values_mod_42}
  \uses{lem:odd_case_mod_seven_constraint}
  \leanok
  If $n$ is odd with $n \geq 5$ and $x^2 + 7 = 2^n$, then
  $(n - 2) \bmod 42 \in \{3, 5, 13\}$.

  This follows from $(-2)^{n-3} \equiv n - 2 \pmod{7}$ together with
  Fermat's little theorem $2^6 \equiv 1 \pmod{7}$. Checking residues modulo $42$
  (combining mod $6$ and mod $7$) yields the three residue classes.
\end{theorem}
\begin{proof}\leanok
  Exhaustive check of residues modulo $42$ using the mod $7$ constraint
  and Fermat's little theorem.
\end{proof}

\subsection{Uniqueness per residue class}

The mod $42$ constraint narrows $m = n - 2$ to three residue classes.
To show that each class contains at most one solution, we use a $7$-adic argument.

\begin{lemma}[Corollary C: theta expression is universal]
  \label{lem:corollary_C}
  \lean{corollary_C}
  \uses{lem:main_m_condition}
  \leanok
  Any two solutions of the Ramanujan--Nagell equation produce the same
  theta expression: if $(x_1^2 + 7)/4 = 2^{m_1}$ and $(x_2^2 + 7)/4 = 2^{m_2}$
  for odd $m_1, m_2 \geq 3$, then $\theta^{m_1} - \theta'^{\,m_1} = \theta^{m_2} - \theta'^{\,m_2}$.
\end{lemma}
\begin{proof}\leanok
  Both sides equal $-2\theta + 1$ by the main $m$-condition.
\end{proof}

\begin{definition}[Binomial sum $B_d$]
  \label{def:binomial_B}
  \lean{binomial_B}
  \leanok
  Define the odd-indexed binomial sum
  \[
    B_d = \sum_{j=0}^{(d-1)/2} \binom{d}{2j+1} \cdot (-7)^j.
  \]
  This arises from expanding $(1+\sqrt{-7})^d = A_d + \sqrt{-7} \cdot B_d$.
\end{definition}

\begin{lemma}[7-adic valuation of $B_d$]
  \label{lem:lemma_A_valuation}
  \lean{lemma_A_binomial_valuation}
  \uses{def:binomial_B}
  \leanok
  The $7$-adic valuation of $B_d$ equals $v_7(d)$: if $7^l \| d$
  (i.e.\ $7^l \mid d$ but $7^{l+1} \nmid d$), then $7^l \mid B_d$
  and $7^{l+1} \nmid B_d$.

  This is the core of the $7$-adic analysis: the $j=0$ term of $B_d$ equals $d$,
  and all higher terms have strictly larger $7$-adic valuation.
\end{lemma}
\begin{proof}\leanok
  The $j=0$ term is $d$ with valuation $l$. Each $j \geq 1$ term has
  $7$-adic valuation $\geq l+1$, so by the ultrametric property the
  sum has valuation exactly $l$.
\end{proof}

\begin{lemma}[7-adic valuation of $B_d$ (conjugate)]
  \label{lem:lemma_B_valuation}
  \lean{lemma_B_binomial_valuation}
  \uses{lem:lemma_A_valuation}
  \leanok
  Same valuation result as Lemma~\ref{lem:lemma_A_valuation}, used for the conjugate $\theta'$.
  Since $B_d$ appears in both $(1+\sqrt{-7})^d$ and $(1-\sqrt{-7})^d$ (with only a sign change
  on $\sqrt{-7}$), the valuation is identical.
\end{lemma}
\begin{proof}\leanok
  Identical to Lemma~\ref{lem:lemma_A_valuation}.
\end{proof}

\begin{definition}[Even-indexed binomial sum $A'_d$]
  \label{def:binomial_A_prime}
  \lean{binomial_A'}
  \leanok
  Define the even-indexed binomial sum
  \[
    A'_d = \sum_{j=0}^{d/2-1} \binom{d}{2(j+1)} \cdot (-7)^j.
  \]
  This arises from the even-index part of the expansion of $(1+\sqrt{-7})^d$.
\end{definition}

\begin{lemma}[7-adic valuation of $A'_d$]
  \label{lem:even_binomial_valuation}
  \lean{even_binomial_valuation}
  \uses{def:binomial_A_prime}
  \leanok
  If $7^l \| d$ and $7 \mid d$, then $7^l \mid A'_d$ and $7^{l+1} \nmid A'_d$.
  The $j=0$ term $\binom{d}{2} = d(d-1)/2$ has valuation $l$, and all higher terms
  have strictly larger $7$-adic valuation.
\end{lemma}
\begin{proof}\leanok
  Same structure as for $B_d$: the leading term $\binom{d}{2}$ has valuation $l$,
  and higher terms are absorbed.
\end{proof}

\begin{definition}[Trace sequence]
  \label{def:trace_seq}
  \lean{trace_seq}
  \leanok
  Define the integer recurrence $a(0) = 2$, $a(1) = 1$, $a(n+2) = a(n+1) - 2\,a(n)$.
  This is the trace sequence: $a(n) = \theta^n + \theta'^{\,n}$ in $R$.
\end{definition}

\begin{lemma}[Trace sequence equals $\theta^n + \theta'^{\,n}$]
  \label{lem:trace_seq_eq}
  \lean{trace_seq_eq}
  \uses{def:trace_seq, lem:two_factorisation_R}
  \leanok
  For all $n$, $\mathrm{trace\_seq}(n) = \theta^n + \theta'^{\,n}$ in $R$.
\end{lemma}
\begin{proof}\leanok
  Induction on $n$ using the recurrence, with $\theta + \theta' = 1$ and $\theta \cdot \theta' = 2$.
\end{proof}

\begin{lemma}[Trace sequence not divisible by $7$]
  \label{lem:trace_seq_not_dvd_seven}
  \lean{trace_seq_not_dvd_seven}
  \uses{def:trace_seq}
  \leanok
  For all $n$, $7 \nmid a(n)$. The recurrence has period $3$ modulo $7$,
  and the three residues $a(0) \equiv 2$, $a(1) \equiv 1$, $a(2) \equiv -3$ are all nonzero mod $7$.
\end{lemma}
\begin{proof}\leanok
  Show the recurrence is periodic mod $7$ with period $3$, then check all three residues.
\end{proof}

\begin{lemma}[Even iff not odd]
  \label{lem:nat_even_iff_not_odd}
  \lean{nat_even_iff_not_odd}
  \leanok
  For natural numbers, $n$ is even if and only if $n$ is not odd.
\end{lemma}
\begin{proof}\leanok
  Immediate from \texttt{not\_odd\_iff\_even}.
\end{proof}

\begin{lemma}[At most one solution per residue class]
  \label{lem:at_most_one_m}
  \lean{at_most_one_m_per_class}
  \uses{lem:corollary_C, lem:lemma_A_valuation, lem:lemma_B_valuation, lem:even_binomial_valuation, lem:trace_seq_eq, lem:trace_seq_not_dvd_seven, lem:nat_even_iff_not_odd}
  \leanok
  If $m_1, m_2$ are both odd, $\geq 3$, satisfy $m_1 \equiv m_2 \pmod{42}$,
  and both give $-2\theta + 1 = \theta^{m_i} - \theta'^{\,m_i}$, then $m_1 = m_2$.

  Proof sketch: if $m_1 \neq m_2$, let $d = |m_2 - m_1|$, which is divisible by $42$
  (hence by $7$). The $7$-adic analysis of Lemma~\ref{lem:lemma_A_valuation} combined
  with Corollary~C yields a contradiction on the valuation of $\sqrt{-7} \cdot B_d$.
\end{lemma}
\begin{proof}\leanok
  Contradiction via $7$-adic valuation: $d$ is divisible by $42$ (hence $7$),
  and the valuation identity forces an impossible parity.
\end{proof}

\subsection{Verification of known solutions}

\begin{lemma}[Verification: $m = 3$ (i.e.\ $n = 5$)]
  \label{lem:theta_eq_at_3}
  \lean{theta_eq_at_3}
  \uses{lem:main_m_condition}
  \leanok
  $-2\theta + 1 = \theta^3 - \theta'^{\,3}$.
  Verified via $x = 5$: $(25 + 7)/4 = 8 = 2^3$.
\end{lemma}
\begin{proof}\leanok
  Direct computation using $\theta^2 = \theta - 2$.
\end{proof}

\begin{lemma}[Verification: $m = 5$ (i.e.\ $n = 7$)]
  \label{lem:theta_eq_at_5}
  \lean{theta_eq_at_5}
  \uses{lem:main_m_condition}
  \leanok
  $-2\theta + 1 = \theta^5 - \theta'^{\,5}$.
  Verified via $x = 11$: $(121 + 7)/4 = 32 = 2^5$.
\end{lemma}
\begin{proof}\leanok
  Direct computation using $\theta^2 = \theta - 2$.
\end{proof}

\begin{lemma}[Verification: $m = 13$ (i.e.\ $n = 15$)]
  \label{lem:theta_eq_at_13}
  \lean{theta_eq_at_13}
  \uses{lem:main_m_condition}
  \leanok
  $-2\theta + 1 = \theta^{13} - \theta'^{\,13}$.
  Verified via $x = 181$: $(32761 + 7)/4 = 8192 = 2^{13}$.
\end{lemma}
\begin{proof}\leanok
  Direct computation using $\theta^2 = \theta - 2$.
\end{proof}

\subsection{Combining}

\begin{theorem}[Odd case: only three values]
  \label{thm:odd_case_only_three_values}
  \lean{odd_case_only_three_values}
  \uses{thm:odd_case_mod_42, lem:reduction_divide_by_4, lem:main_m_condition, lem:at_most_one_m, lem:theta_eq_at_3, lem:theta_eq_at_5, lem:theta_eq_at_13}
  \leanok
  If $n$ is odd with $n \geq 5$ and $x^2 + 7 = 2^n$, then $n \in \{5, 7, 15\}$.

  From the mod $42$ constraint, $m = n - 2$ lies in one of three residue classes
  ($3$, $5$, or $13$ mod $42$). The verification lemmas show these are actual solutions
  (at $m = 3, 5, 13$). The uniqueness lemma shows each residue class has at most one
  solution. Therefore $n \in \{5, 7, 15\}$.
\end{theorem}
\begin{proof}\leanok
  Combine the mod $42$ constraint, uniqueness per class, and verification of
  the three known solutions.
\end{proof}

\section{Main theorem}

\begin{lemma}[Auxiliary: $n \geq 4$ and $n \neq 4$ implies $n \geq 5$]
  \label{lem:omg}
  \lean{omg}
  \leanok
  If $n \geq 4$ and $n \neq 4$, then $n \geq 5$.
\end{lemma}
\begin{proof}\leanok
  Immediate by \texttt{omega}.
\end{proof}

\subsection{Direct computation helpers}

Once the possible values of $n$ are determined (either by the even-case factorization or
the odd-case modular argument), it remains to solve for $x$ by direct computation.
Each helper below takes an equation $x^2 = c$ (where $c = 2^n - 7$) and the value of $n$,
then identifies the solution pair $(x, n)$ in the list of solutions.

\begin{lemma}[Even case: $n = 4$, $x^2 = 9$]
  \label{lem:helper_1}
  \lean{helper_1}
  \leanok
  If $x^2 = 9$ and $n = 4$, then $(x, n) = (\pm 3, 4)$.
\end{lemma}
\begin{proof}\leanok Solve $x^2 = 9$. \end{proof}

\begin{lemma}[Odd case: $n = 3$, $x^2 = 1$]
  \label{lem:helper_2}
  \lean{helper_2}
  \leanok
  If $x^2 = 1$ and $n = 3$, then $(x, n) = (\pm 1, 3)$.
\end{lemma}
\begin{proof}\leanok Solve $x^2 = 1$. \end{proof}

\begin{lemma}[Odd case: $n = 5$, $x^2 = 25$]
  \label{lem:helper_3}
  \lean{helper_3}
  \leanok
  If $x^2 = 25$ and $n = 5$, then $(x, n) = (\pm 5, 5)$.
\end{lemma}
\begin{proof}\leanok Solve $x^2 = 25$. \end{proof}

\begin{lemma}[Odd case: $n = 7$, $x^2 = 121$]
  \label{lem:helper_4}
  \lean{helper_4}
  \leanok
  If $x^2 = 121$ and $n = 7$, then $(x, n) = (\pm 11, 7)$.
\end{lemma}
\begin{proof}\leanok Solve $x^2 = 121$. \end{proof}

\begin{lemma}[Odd case: $n = 15$, $x^2 = 32761$]
  \label{lem:helper_5}
  \lean{helper_5}
  \leanok
  If $x^2 = 32761$ and $n = 15$, then $(x, n) = (\pm 181, 15)$.
\end{lemma}
\begin{proof}\leanok Solve $x^2 = 32761$. \end{proof}

\subsection{The theorem}

\begin{theorem}[Ramanujan--Nagell]
  \label{thm:RamanujanNagell}
  \lean{RamanujanNagell}
  \uses{lem:x_is_odd, lem:ramanujan_nagell_even_pow_factors, thm:odd_case_only_three_values, lem:helper_1, lem:helper_2, lem:helper_3, lem:helper_4, lem:helper_5}
  \leanok
  The only integer solutions to $x^2 + 7 = 2^n$ are
  \[
    (x, n) \in \{(\pm 1, 3),\; (\pm 3, 4),\; (\pm 5, 5),\; (\pm 11, 7),\; (\pm 181, 15)\}.
  \]
\end{theorem}
\begin{proof}
  \leanok
  First, one shows $n \geq 3$ by bounding $2^n \geq x^2 + 7 \geq 7$.
  Then $x$ must be odd (Lemma~\ref{lem:x_is_odd}).

  \textbf{Case 1: $n$ even.} Write $n = 2k$. Then $(2^k+x)(2^k-x) = 7$.
  By Lemma~\ref{lem:ramanujan_nagell_even_pow_factors}, the only possibility is $2^k = 4$,
  giving $n = 4$ and $x = \pm 3$ (Lemma~\ref{lem:helper_1}).

  \textbf{Case 2: $n$ odd, $n = 3$.} Direct computation gives $x^2 = 1$, so $x = \pm 1$
  (Lemma~\ref{lem:helper_2}).

  \textbf{Case 3: $n$ odd, $n \geq 5$.} By Theorem~\ref{thm:odd_case_only_three_values},
  $n \in \{5, 7, 15\}$, and direct computation gives the remaining solutions
  (Lemmas~\ref{lem:helper_3}, \ref{lem:helper_4}, \ref{lem:helper_5}).
\end{proof}
